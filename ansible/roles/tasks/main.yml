- name: Install Git
  apt:
    name: git
    state: present
    update_cache: yes

- name: Install Docker
  apt:
    name:
      - docker.io
      - docker-compose
      - python3-docker
    state: present

- name: Start and enable Docker
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Add current user to docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes

- name: Create directory for GitLab Runner
  file:
    path: /opt/gitlab-runner
    state: directory
    mode: '0755'

- name: Copy ALL GitLab Runner files at once
  copy:
    src: "{{ role_path }}/../files/"  # копируем всю папку files
    dest: /opt/gitlab-runner/
    mode: '0644'
    directory_mode: '0755'

- name: Make scripts executable
  file:
    path: /opt/gitlab-runner/register.sh
    mode: '0755'

- name: Create .env file from template
  template:
    src: "{{ role_path }}/templates/.env.j2"
    dest: /opt/gitlab-runner/.env
    mode: '0600'

- name: Pull GitLab Runner image
  docker_image:
    name: gitlab/gitlab-runner:alpine
    source: pull

- name: Start GitLab Runner with Docker Compose
  docker_compose:
    project_src: /opt/gitlab-runner
    files:
      - docker-compose.yml
    state: present
    restarted: yes

- name: Wait for runner to start
  pause:
    seconds: 15

- name: Check runner status
  command: docker ps --filter "name=gitlab-runner"
  register: runner_status

- name: Show success message
  debug:
    msg:
      - "✅ GitLab Runner успешно установлен!"
      - "Статус: {{ runner_status.stdout_lines | default('не определен') }}"
      - "Файлы в: /opt/gitlab-runner/"
      - "Логи: docker logs gitlab-runner"
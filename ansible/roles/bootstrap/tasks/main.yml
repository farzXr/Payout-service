- name: Create ansible user
  user:
    name: ansible
    state: present
    shell: /bin/bash
    groups: sudo
    append: yes

- name: Deploy SSH key
  authorized_key:
    user: ansible
    state: present
    key: "{{ lookup('file', '{{ playbook_dir }}/../files/ansible_id_rsa.pub') }}"

- name: Configure passwordless sudo
  lineinfile:
    path: /etc/sudoers.d/ansible
    line: "ansible ALL=(ALL) NOPASSWD:ALL"
    create: yes
    mode: '0440'
# Deploy проекта payout-service на production

1. Я использовал ansible для подготовки целевого сервера к развёртыванию на нём payout-service и cicd.

2. Для секретов использовал HahsiCorp Vault (пароль от целевого сервера/access-token от gitlab/...).

3. Я организовал их docker-compose для удобства переносимости этой системы автоматизированного развёртывания.

## Архитектура решения
1. Ansible для подготовки целевого сервера к развёртыванию payout-service и настройки CI/CD

2. Hashicorp Vault для безопасного хранения секретов (пароли серверов, GitLab токены и т.д.)

3. Docker Compose для удобства переносимости системы автоматизированного развёртывания

### Использование

- Базовые команды
```commandline
# Для запуска подготовки целевого сервера к развёртыванию
make deploy

# Для перенастройки целевого сервера (полный сброс и повторное развёртывание)
make reset_deploy
```

### Подробное описание make deploy

#### Этап 1: Подготовка и запуск инфраструктуры

 При запуске make deploy автоматически:
- Запускаются контейнеры Vault и Ansible

- Настраивается сетевое взаимодействие между сервисами

- Подготавливается окружение для работы с секретами

#### Этап 2: Настройка Vault (требует ручного вмешательства)

Необходимо выполнить:

1. Разблокировка Vault

После запуска Vault потребуется ввести 3 ключа для разблокировки (unseal keys):

```commandline
Unseal Key 1: nbUCl/9XQvr/YYxrLTShQQFQ0A4AW3Wqjrbusr2x8f4u
Unseal Key 2: cSb3/rr7mYEOuxtOKQAT2q1XlMqDMNEObZ5OAgS7JpJj
Unseal Key 3: AQRtexcZ84tftbmQSax46zWWM6HifrAqhRwdUpK2jxhJ
Unseal Key 4: PCaRIwJZSnCDDBMfsSXbxkjlEY1hqreC4czLBR/SmTAZ
Unseal Key 5: +PrI5saLQiARGA1PdZxhsaCggdkK0cvUSeatb5zoK59p
```
*Ключи отображаются в терминале сразу после запуска*

2. Авторизация в Vault

Используйте root token для начальной настройки:

```commandline
Initial Root Token: hvs.FPSrL8m2FaQ4YwKpwAcYSpyI
```
3. Настройка секретов

Введите следующие данные при запросе:

- SSH пароль root целевого сервера

- Access token GitLab аккаунта с правами API (для создания токенов gitlab-runner)

4. Создание пользователя Vault

Создайте пользователя для последующей авторизации в Vault

#### Этап 3: Настройка Ansible
Необходимо выполнить:

1. GitLab Project Slug

```commandline
Введите значение для gitlab_project_slug:
```

*У вас должен быть удалённый репозиторий с этим проектом на GitLab*

2. Ansible Vault Пароль

```commandline
Введите пароль для ansible-vault:
```

*Можно использовать любой пароль, не обязательно запоминать*

3. IP адрес целевого сервера

```commandline
Введите IP целевого сервера:
```

## Что устанавливается на целевом сервере
После успешного выполнения make deploy на целевом сервере будут:

### ✅ Установленные зависимости
- Docker и Docker Compose

- Необходимые системные пакеты

- Настроенный SSH доступ

### ✅ GitLab Runner
- Установлен и зарегистрирован GitLab Runner

- Настроена привязка к вашему проекту GitLab

- Конфигурация для автоматического развёртывания

### ✅ Готовность к CI/CD
- Автоматическая сборка при пуше в репозиторий

- Развёртывание на целевом сервере

- Мониторинг статуса пайплайнов

## Работа с проектом после развёртывания

### Для разработчиков
1. Клонируйте репозиторий GitLab

2. Внесите изменения в код

3. Запушьте изменения:
```commandline
git add .
git commit -m "Описание изменений"
git push origin main
```

### Автоматический процесс CI/CD

После пуша в GitLab:

- GitLab Runner автоматически запускает пайплайн

- Проект собирается в Docker образ

- Образ развёртывается на целевом сервере

- Применяются миграции и настройки

## Устранение неполадок

Если развёртывание не работает
1. Проверьте, что GitLab Runner запущен:
```commandline
docker ps | grep gitlab-runner
```
2. Проверьте статус пайплайна в GitLab UI:

- Проект → CI/CD → Pipelines

3. Проверьте логи GitLab Runner:
```commandline
docker logs <runner_container_id>
```

## Для повторной настройки

```commandline
# Полная переустановка
make reset_deploy
make deploy
```

## Требования перед запуском

### Обязательные
- Удалённый репозиторий GitLab с проектом

- SSH доступ к целевому серверу (root пароль)

- GitLab access token с правами API

- Docker и Docker Compose на локальной машине
